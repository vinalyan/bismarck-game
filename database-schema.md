# Схема взаимоотношений между сущностями в БД игры "Погоня за Бисмарком"

## Основные сущности и их связи

### 1. Пользователи (Users)
- **users** - основная таблица пользователей
- **user_sessions** - сессии пользователей (1:N с users)
- **user_preferences** - настройки пользователей (1:1 с users)
- **user_achievements** - достижения пользователей (1:N с users)

### 2. Игры (Games)
- **games** - основная таблица игр
- **game_states** - состояния игры по ходам/фазам (1:N с games)

### 3. Юниты (Units)
- **naval_units** - морские юниты (корабли) (1:N с games)
- **air_units** - воздушные юниты (самолеты) (1:N с games)
- **task_forces** - оперативные соединения (1:N с games)

### 4. Игровые действия
- **unit_movements** - движения юнитов (1:N с games, 1:N с naval_units)
- **unit_searches** - поисковые действия (1:N с games, 1:N с naval_units/air_units)
- **damage_records** - записи повреждений (1:N с naval_units)

## Связи между сущностями

### Пользователи ↔ Игры
- **users** (1) ↔ (0..1) **games.player1_id** (немецкий игрок)
- **users** (1) ↔ (0..1) **games.player2_id** (союзник)

### Игры ↔ Игровые состояния
- **games** (1) ↔ (N) **game_states** (состояния по ходам/фазам)

### Игры ↔ Юниты
- **games** (1) ↔ (N) **naval_units** (корабли в игре)
- **games** (1) ↔ (N) **air_units** (самолеты в игре)
- **games** (1) ↔ (N) **task_forces** (соединения в игре)

### Юниты ↔ Соединения
- **naval_units** (N) ↔ (0..1) **task_forces** (корабли могут быть в соединении)

### Юниты ↔ Действия
- **naval_units** (1) ↔ (N) **unit_movements** (движения кораблей)
- **naval_units** (1) ↔ (N) **unit_searches** (поиски кораблей)
- **air_units** (1) ↔ (N) **unit_searches** (поиски самолетов)
- **naval_units** (1) ↔ (N) **damage_records** (повреждения кораблей)

### Пользователи ↔ Сессии
- **users** (1) ↔ (N) **user_sessions** (активные сессии)

### Пользователи ↔ Настройки
- **users** (1) ↔ (1) **user_preferences** (настройки пользователя)

### Пользователи ↔ Достижения
- **users** (1) ↔ (N) **user_achievements** (достижения пользователя)

## Ключевые особенности схемы

### Идентификаторы
- Все таблицы используют UUID в качестве первичного ключа
- Внешние ключи ссылаются на UUID родительских таблиц

### Временные метки
- Все таблицы содержат `created_at` и `updated_at`
- Игры имеют дополнительные временные поля: `started_at`, `completed_at`, `last_action_at`

### JSON поля
- **games.settings** - настройки игры (JSONB)
- **game_states.state_data** - данные состояния игры (JSONB)
- **naval_units.damage** - массив повреждений (JSONB)
- **task_forces.units** - массив ID юнитов в соединении (JSONB)

### Индексы
- Индексы на часто используемые поля для оптимизации запросов
- Составные индексы для сложных запросов по играм и пользователям

### Ограничения
- Уникальные ограничения на username и email в таблице users
- Внешние ключи с каскадным удалением для зависимых записей
- Проверочные ограничения для валидации статусов и фаз игры
